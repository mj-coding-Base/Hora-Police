# üõ°Ô∏è File-Based Malware Detection

Sentinel now includes comprehensive file-based malware detection and blocking capabilities to protect against known malicious files.

## üéØ Features

- **Signature-Based Detection**: Detects malware by file name, path patterns, and file hashes
- **Automatic Quarantine/Deletion**: Safely isolates or removes detected malware files
- **Process Termination**: Automatically kills processes using malicious files
- **Built-in Signatures**: Pre-configured with common malware patterns including:
  - `solrz` - Malicious binary
  - `e386` - Malicious binary  
  - `payload.so` - Malicious shared library
  - `next` - Malicious file in `.local/share/`
  - Crypto miner patterns
  - Suspicious shared library locations

## üìã Configuration

Add the following section to your `config.toml`:

```toml
[file_scanning]
# Enable file system malware scanning
enabled = true

# How often to scan for malware files (in minutes)
scan_interval_minutes = 15

# Directories to scan for malware files
scan_paths = [
    "/home",
    "/tmp",
    "/var/tmp",
    "/opt",
]

# Directory where quarantined files will be stored
quarantine_path = "/var/lib/sentinel/quarantine"

# Automatically delete malware files instead of quarantining
# WARNING: This permanently deletes files. Use with caution!
auto_delete = false

# Kill processes that are using detected malware files
kill_processes_using_file = true
```

## üîç How It Works

1. **Periodic Scanning**: The daemon scans configured directories at regular intervals (default: every 15 minutes)

2. **Signature Matching**: Each file is checked against malware signatures:
   - File name patterns (regex)
   - Path patterns (regex)
   - File hash (SHA256) - for exact matches

3. **Detection Actions**:
   - **Kill Processes**: If `kill_processes_using_file = true`, all processes using the malicious file are terminated
   - **Quarantine/Delete**: File is either moved to quarantine directory or permanently deleted based on `auto_delete` setting

4. **Logging**: All detections are logged to the database (`malware_files` table) and optionally sent via Telegram alerts

## üìä Database Schema

The `malware_files` table tracks all detected malware:

```sql
CREATE TABLE malware_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    file_hash TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    signature_name TEXT NOT NULL,
    threat_level REAL NOT NULL,
    action_taken TEXT NOT NULL,  -- "quarantined" or "deleted"
    quarantine_path TEXT,
    detected_at DATETIME NOT NULL
);
```

## üîé Querying Detected Malware

```bash
# View all detected malware files
sudo sqlite3 /var/lib/sentinel/intelligence.db \
  "SELECT * FROM malware_files ORDER BY detected_at DESC;"

# Count malware files detected today
sudo sqlite3 /var/lib/sentinel/intelligence.db \
  "SELECT COUNT(*) FROM malware_files WHERE detected_at > datetime('now', '-1 day');"

# View quarantined files
sudo sqlite3 /var/lib/sentinel/intelligence.db \
  "SELECT file_path, quarantine_path, detected_at FROM malware_files WHERE action_taken = 'quarantined';"
```

## üö® Specific Malware Signatures

The following malware files are automatically detected and blocked:

| File Name | Location Pattern | Threat Level |
|-----------|------------------|--------------|
| `solrz` | Any location | 1.0 (Critical) |
| `e386` | Any location | 1.0 (Critical) |
| `payload.so` | Any location | 1.0 (Critical) |
| `next` | `~/.local/share/next` | 1.0 (Critical) |

## üõ†Ô∏è Adding Custom Signatures

You can add custom malware signatures by modifying `src/file_scanner.rs`:

```rust
MalwareSignature {
    name: "custom_malware".to_string(),
    file_name_pattern: Some(Regex::new(r"^malicious_file$").unwrap()),
    path_pattern: Some(Regex::new(r".*[/\\]suspicious[/\\]path").unwrap()),
    file_hash: Some("abc123...".to_string()), // Optional SHA256 hash
    threat_level: 1.0,
    description: "Custom malware description".to_string(),
}
```

## üìà Performance Impact

- **Scan Frequency**: Configurable (default: every 15 minutes)
- **CPU Usage**: Minimal during scans (<5% for typical directories)
- **Memory**: Additional ~10-20MB for file scanner
- **Disk I/O**: Moderate during scans, minimal otherwise

## ‚ö†Ô∏è Important Notes

1. **Quarantine Directory**: Ensure `/var/lib/sentinel/quarantine` exists and has proper permissions:
   ```bash
   sudo mkdir -p /var/lib/sentinel/quarantine
   sudo chown root:root /var/lib/sentinel/quarantine
   sudo chmod 700 /var/lib/sentinel/quarantine
   ```

2. **Scan Paths**: Be careful when adding system directories to `scan_paths`. Scanning `/` or `/usr` may cause performance issues.

3. **Auto-Delete**: When `auto_delete = true`, files are permanently removed. Use with caution in production environments.

4. **Process Killing**: When `kill_processes_using_file = true`, any process using a detected malware file will be terminated. This may affect legitimate processes if false positives occur.

## üß™ Testing

Test the file scanner by creating a test malware file:

```bash
# Create a test file matching a signature
touch /tmp/solrz
chmod +x /tmp/solrz

# Wait for next scan (or trigger manually if you modify scan_interval_minutes)
# Check logs
sudo journalctl -u sentinel -f

# Verify detection in database
sudo sqlite3 /var/lib/sentinel/intelligence.db \
  "SELECT * FROM malware_files WHERE file_path LIKE '%solrz%';"
```

## üîÑ Integration with Existing Features

File-based malware detection integrates seamlessly with Sentinel's existing features:

- **Telegram Alerts**: Real-time alerts when malware files are detected (if `real_time_alerts = true`)
- **Daily Reports**: Malware file counts included in daily Telegram reports
- **Database Logging**: All detections logged for forensic analysis
- **Process Monitoring**: Works alongside CPU abuse detection and other monitors

## üìù Log Messages

Watch for these log messages:

- `üîç Starting file system malware scan...` - Scan started
- `üö® Found X malicious file(s)!` - Malware detected
- `‚úÖ File scan complete - no malware detected` - Clean scan
- `‚úÖ Quarantined file: ...` - File quarantined
- `üóëÔ∏è Deleted malicious file: ...` - File deleted
- `üî™ Killing process PID X using malicious file: ...` - Process terminated

## üêõ Troubleshooting

**Files not being detected:**
- Check that `file_scanning.enabled = true`
- Verify scan paths exist and are accessible
- Check scan interval (may need to wait for next scan)
- Review logs: `sudo journalctl -u sentinel | grep -i "file scan"`

**False positives:**
- Review detected files in database
- Adjust signature patterns if needed
- Add legitimate files to exclusion list (future feature)

**Performance issues:**
- Increase `scan_interval_minutes` (e.g., 30 or 60)
- Reduce number of directories in `scan_paths`
- Exclude large directories like `/var/log` or `/usr`

---

**File-based malware detection is now active and protecting your system!** üõ°Ô∏è

